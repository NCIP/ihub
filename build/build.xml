<?xml version="1.0" encoding="utf-8" ?>
<!-- bda-build-template version 1.0.1 -->
<!--
$Id: build.xml 1679 2009-05-21 18:14:55Z saksass $
$HeadURL: https://gforge.nci.nih.gov/svnroot/automation/trunk/software/bda-build-template/software/build/build.xml $
-->

<project name="caXchange build script" default="build:all" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:cs="antlib:com.puppycrawl.tools.checkstyle">
	<description>
		This build file is part of the bda-build-template project.  This is the master build file for the project.  It should be placed in project/software/.  This script wrappers sub projects to build, test and inspect code.  Additionally this project manges creation of distributions and deployment locally or remotely.  Deployments will call the install.xml from the distribution to install or upgrade the application.  Lastly this script will run include targets that require manipulation of containers (selenium tests because they require starting the application server container (and require a fully deployed application which this process is responsible for). This build script assumes two sub-projects caXchangeInboundService and mirth-components. The API targets are commented out and can be removed if not needed.  Also support for both tomcat and mirth download, install and configure are included.  These scripts require Java, Ant, Database and SVN to work.
	</description>

	<!-- Property file related properties and tasks -->
	<property environment="env" />
	<!--<property name="env.MAVEN_OPTS" value="-Xms512m -Xmx1024m -XX:MaxPermSize=256m" />-->
	<!-- The project.properties stores properties that are shared between both build.xml and install.xml. Typically properties that are related to the distribution directories, or files. -->
	<property file="local.properties" />
	<property file="project.properties" />
	<property name="properties.file" value="install.properties" />
	<property name="upgrade.properties.file" value="upgrade.properties" />
	<echo message="Using properties file of ${properties.file}." />
	<available file="${properties.file}" property="properties.file.exists" />
	<fail unless="properties.file.exists" message="The properties.file ${properties.file} does not exist, please make sure that you pass in an accurate file name with the 'ant -Dproperties.file=somepath/somefile', otherwise the build will fail." />

	<replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=(.*[\w\d\/\{\}\\]+)[ \t]+\r*$" replace="\1=\2" />
	<replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=[ \t]+(.*[\w\d\/\{\}\\]+)\r*$" replace="\1=\2" />
	<property file="${properties.file}" />

	<!-- Set application.base.path based on platform -->
	<condition property="application.base.path" value="${application.base.path.linux}">
		<or>
			<os family="unix" />
			<os family="mac" />
		</or>
	</condition>

	<condition property="application.base.path" value="${application.base.path.windows}">
		<os family="windows" />
	</condition>
	<property name="tomcat.home" value="${application.base.path}/${tomcat.relative.path}" />
	<property name="mirth.home" value="${application.base.path}/${mirth.relative.path}" />
	<property name="axis.2.home" value="${application.base.path}/${axis.2.relative.path}" />
	<property name="activemq.home" value="${application.base.path}/${activemq.relative.path}" />


	<!-- added for remote deployments since file is copied to root of install dir -->
	<basename property="properties.file.name" file="${properties.file}" />

	<!-- BDA standard structure -->
	<property name="build.dir" location="." />
	<property name="software.dir" location=".." />
	<property name="common.dir" location="${software.dir}/common" />
	<property name="local.repo.dir" location="${software.dir}/local-ivy-repo" />
	<property name="target.dir" location="${software.dir}/target" />
	<property name="bda-download.dir" location="${common.dir}/bda-download" />
	<property name="ivy.settings.dir" location="${common.dir}/ivy" />
	<property name="lib.dir" location="${target.dir}/lib" />
	<property name="temp.dir" location="${target.dir}/temp" />
	<property name="reports.dir" location="${target.dir}/reports" />
	<property name="bda-utils.dir" location="${target.dir}/bda-utils" />
	<property name="log.dir" location="${target.dir}/logs" />
	<property name="dist.dir" location="${target.dir}/dist" />
	<property name="download.dir" location="${target.dir}/download" />
	<property name="pt.dir" location="${target.dir}/persistent-transient" />
	<property name="working.dir" location="${target.dir}/working" />
	<property name="cacore-sdk.dir" location="${target.dir}/${cacore-sdk.binaries.relative.dir}" />
	<property name="gui-installer-build.dir" location="${build.dir}/gui-installer" />


	<!-- Ivy Related props -->
	<property name="ivy.settings.file" value="ivy-bda-settings.xml" />
	<property name="ivy.jar.file" value="ivy-2.0.0.jar" />

	<!-- Properties that relate to how to call build targets from sub-projects-->
	<!-- Working directory passed to Ant tasks -->
	<!--<property name="servicemix-components.base.dir" value="${software.dir}/servicemix-components" />-->
	<property name="mirth-components.base.dir" value="${software.dir}/mirth-components" />
	<property name="caXchangeInboundService.base.dir" value="${software.dir}/caXchangeInboundService" />
	<property name="OpenClinicaPlugin.base.dir" value="${software.dir}/openClinicaCCTSPlugin" />
	<property name="OpenClinicaWebSSOClient.base.dir" value="${software.dir}/openClinicaWebSSOClient" />
	<property name="OpenClinicaConsumerService.base.dir" value="${software.dir}/occservice" />
	<property name="CaXchangeConsumerService.base.dir" value="${software.dir}/CaXchangeConsumerService" />
	<property name="integration-smoke-test.base.dir" value="${software.dir}/integration-smoke-test" />

	<!-- Build file names relative working dir above, if the basedir of the sub-project ant script is ".." you should set the *.basdir to and the build file should include the dir and build file name from the *.base.dir -->
	<property name="caXchangeInboundService.build.file" value="build.xml" />
	<property name="OpenClinicaPlugin.build.file" value="build.xml" />
	<property name="OpenClinicaWebSSOClient.build.file" value="build.xml" />
	<property name="OpenClinicaConsumerService.build.file" value="build.xml" />
	<property name="mirth-components.build.file" value="build.xml" />
	<property name="integration-smoke-test.build.file" value="build.xml" />


	<!-- The target name that should be called from the sub-project build file -->
	<property name="mirth-components.build.target" value="dist" />
	<property name="caXchangeInboundService.build.target" value="dist" />
	<property name="OpenClinicaPlugin.build.target" value="main" />
	<property name="OpenClinicaWebSSOClient.build.target" value="dist" />
	<property name="OpenClinicaConsumerService.build.target" value="dist" />
	<property name="integration-smoke-test.build.target" value="dist" />

	<!-- Maven comamnd line arguments, bda profile is inside profiles.xml that gets copied to ear folder before build to override exiting properties -->
	<property name="caXchangeInboundService.maven.profile.list" value="local,bda" />
	<property name="caXchangeInboundService.maven.goal.list" value="clean install" />
	<!--<property name="mirth-components.maven.profile.list" value="local,bda" />
	<property name="mirth-components.maven.goal.list" value="" />
	<property name="mirth-components.maven.cmdline.opts" value="-Denv=local  -npr -npu  -Dmaven.test.skip=true install assembly:directory -settings ${mirth-components.base.dir}/settings.xml" />-->

	<!-- Used by dist:*:prep to determin list of files to use for incremental build process.
		Directory and files must be in svn to work.
	-->
	<property name="db.root.src.dir" value="${software.dir}/${db.root.dist.relative.dir}" />
	<property name="db.caxchange.src.dir" value="${software.dir}/${db.caxchange.dist.relative.dir}" />
	<property name="db.caxchange-install.src.dir" value="${db.caxchange.src.dir}/db-install" />
	<property name="db.caxchange-upgrade.src.dir" value="${db.caxchange.src.dir}/db-upgrade" />

	<property name="db.llt.src.dir" value="${software.dir}/${db.llt.dist.relative.dir}" />
	<property name="db.llt-install.src.dir" value="${db.llt.src.dir}/db-install" />
	<property name="db.llt-upgrade.src.dir" value="${db.llt.src.dir}/db-upgrade" />


	<!-- Distribution Structure properties, used to copy files into the distribution area.
       		Use project.properties relative dir names becasue they are used by install also-->
	<property name="dist.exploded.dir" value="${dist.dir}/exploded" />
	<property name="mirth-components.dist.dir" value="${dist.exploded.dir}/${mirth-components.dist.relative.dir}" />
	<property name="caXchangeInboundService.dist.dir" value="${dist.exploded.dir}/${caXchangeInboundService.dist.relative.dir}" />
	<property name="OpenClinica.dist.dir" value="${dist.exploded.dir}/${OpenClinica.dist.relative.dir}" />
	<property name="OpenClinicaWebSSO.dist.dir" value="${dist.exploded.dir}/${OpenClinicaWebSSO.dist.relative.dir}" />
	<property name="OpenClinicaConsumerService.dist.dir" value="${dist.exploded.dir}/${OpenClinicaConsumerService.dist.relative.dir}" />
	<property name="CaXchangeConsumerService.dist.dir" value="${dist.exploded.dir}/${CaXchangeConsumerService.dist.relative.dir}" />
	<property name="integration-smoke-test.dist.dir" value="${dist.exploded.dir}/${integration-smoke-test.dist.relative.dir}" />

	<property name="tools.dist.dir" value="${dist.exploded.dir}/${tools.dist.relative.dir}" />
	<property name="common.dist.dir" value="${dist.exploded.dir}/${common.dist.relative.dir}" />
	<property name="db.root.dist.dir" value="${dist.exploded.dir}/${db.root.dist.relative.dir}" />
	<property name="db.caxchange-install.dist.dir" value="${dist.exploded.dir}/${db.caxchange-install.dist.relative.dir}" />
	<property name="db.caxchange-upgrade.dist.dir" value="${dist.exploded.dir}/${db.caxchange-upgrade.dist.relative.dir}" />
	<property name="db.llt-install.dist.dir" value="${dist.exploded.dir}/${db.llt-install.dist.relative.dir}" />
	<property name="db.llt-upgrade.dist.dir" value="${dist.exploded.dir}/${db.llt-upgrade.dist.relative.dir}" />


	<!-- Where to write files retrieved by get, into the distribution area.  The file names come from project.properties  -->
	<property name="tomcat.dest.file" value="${download.dir}/${tomcat.binaries.file}" />
	<property name="cagrid-libs.dest.file" value="${download.dir}/${cagrid-libs.binaries.file}" />
	<property name="cagrid-base-war.dest.file" value="${download.dir}/${cagrid-base-war.binaries.file}" />

	<property name="mirth.dest.file" value="${download.dir}/${mirth.binaries.file}" />

	<property name="axis.2.file" value="${download.dir}/${axis.2.binaries.file}" />
	
	<property name="activemq.file" value="${download.dir}/${activemq.binaries.file}" />

	<!-- Default install time targets passed by deploy targets to the installer, can be overridden by being set on the command line if different target is desitred.  -->
	<property name="install.target" value="install" />
	<property name="upgrade.target" value="upgrade" />

	<!-- Where grand stores it's outputed pdf reports of build files -->
	<property name="grand.rpt.dir" value="${common.dir}/grand" />

	<!-- retrive ivy.jar.files then retrieve bda files and librarires -->
	<condition property="commonlibrary.dir" value="">
		<or>
			<os family="unix" />
			<os family="mac" />
		</or>
	</condition>

	<condition property="commonlibrary.dir" value="c:/">
		<os family="windows" />
	</condition>

	<condition property="local.cbiit-ivy-repo.dir" value="">
		<or>
			<os family="unix" />
			<os family="mac" />
		</or>
	</condition>

	<condition property="local.cbiit-ivy-repo.dir" value="c:/">
		<os family="windows" />
	</condition>

	<property name="bda-download.file" value="bda-ivy-2.0.0-build.xml" />
	<!--
		<mkdir dir="${bda-download.dir}" />
		<property name="bda-download.src.url" value="http://gforge.nci.nih.gov/svnroot/automation/trunk/software/bda-download/${bda-download.file}" />
		<get src="${bda-download.src.url}" dest="${bda-download.dir}/${bda-download.file}" />
		-->
	<ant inheritAll="false" inheritRefs="false" antfile="${bda-download.file}" target="retrieve-bda" dir="${bda-download.dir}">
		<property name="bda.version" value="${bda.version}" />
		<property name="bda-utils.dir" location="${bda-utils.dir}" />
		<property name="lib.dir" location="${lib.dir}" />
		<property name="software.dir" location="${software.dir}" />
		<property name="commonlibrary.dir" location="${commonlibrary.dir}" />
		<!-- Use below for old ivy repo -->
		<property name="ivy.settings.file" value="ivy-bda-settings.xml"/>
		<!-- Use below for new ivy repo -->
		<!-- <property name="ivy.settings.file" value="cbiit-ivy-bda-settings.xml" /> -->
		<property name="target.dir" location="${target.dir}" />
		<property name="local.cbiit-ivy-repo.dir" value="${local.cbiit-ivy-repo.dir}" />
	</ant>


	<!-- FILTER SETS -->
	<filterset id="buildFilterSet">
		<filtersfile file="${properties.file}" />
	</filterset>

	<!-- Paths -->
	<path id="bda-utils.classpath">
		<fileset dir="${bda-utils.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="ivy.classpath">
		<fileset dir="${lib.dir}">
			<include name="${ivy.jar.file}" />
		</fileset>
	</path>

	<!-- Task definitions -->
	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.classpath" />
	<taskdef name="for" classname="net.sf.antcontrib.logic.ForTask" classpathref="bda-utils.classpath" />

	<!-- Includes- include BDA marcos -->
	<import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />

	<!-- Start logging -->
	<mkdir dir="${log.dir}" />
	<tstamp>
		<format property="install.time" pattern="yyyy-MM-dd-HH-mm" />
	</tstamp>
	<record name="${log.dir}/install-${install.time}.log" action="start" />

	<mkdir dir="${download.dir}" />


	<!-- Targets -->


	<target name="diagnostics" description="diagnostics">
		<echoproperties />
		<diagnostics />
	</target>

	<target name="clean">
		<delete dir="${dist.dir}" />
		<delete dir="${temp.dir}" />
	</target>

	<target name="init" description="Sets up build are and initalizes variables">
		<echo message=" ______   ______   _______ " />
		<echo message="|  __  \ |  ___  ||  ___  |" />
		<echo message="| |__)  )| |   | || |___| | " />
		<echo message="|  __  ( | |   | ||  ___  |" />
		<echo message="| |__)  )| |__/ / | |   | |" />
		<echo message="|______/ |_____/  |_|   |_|" />
		<mkdir dir="${target.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${dist.exploded.dir}" />
		<mkdir dir="${mirth-components.dist.dir}" />
		<mkdir dir="${caXchangeInboundService.dist.dir}" />
		<mkdir dir="${CaXchangeConsumerService.dist.dir}" />
		<mkdir dir="${integration-smoke-test.dist.dir}" />
		<mkdir dir="${common.dist.dir}" />
		<mkdir dir="${tools.dist.dir}" />
		<mkdir dir="${temp.dir}" />
		<mkdir dir="${download.dir}" />
		<mkdir dir="${pt.dir}" />

		<available file="${tomcat.dest.file}" property="tomcat.tools.exists" />
		<!-- If tomcat is required to build, then check for tomcat in tomcat.home, then check for in tomcat in working directory, if not found then download it into this that directory.
		If found at any point set local.tomcat.home to where it is found.  This can be passed to sub-projects so then can compile code against distribution.  This is especially important
		on AntHillPro server which will not have tomcat present, thus will have to use a copy in the working area.  This also makes it easier to start the project, if the developer does
		not yet have tomcat installed, build will download it and install it so build can proceed. -->
		<if>
			<equals arg1="${require.tomcat}" arg2="true" />
			<then>
				<available file="${tomcat.home}/lib/commons-httpclient.jar" property="rt.tomcat.exists" />
				<if>
					<isset property="rt.tomcat.exists" />
					<then>
						<property name="local.tomcat.home" location="${tomcat.home}" />
						<echo message="CATALINA_HOME exists ${tomcat.home}" />
					</then>
					<else>
						<property name="local.tomcat.home" location="${pt.dir}/${tomcat.binaries.relative.dir}" />
						<available file="${local.tomcat.home}/lib/commons-httpclient.jar" property="local.tomcat.exists" />
						<echo message="CATALINA_HOME does not exist checking for LOCAL_CATALINA_HOME ${local.tomcat.home}" />
						<if>
							<not>
								<isset property="local.tomcat.exists" />
							</not>
							<then>
								<echo message="LOCAL_CATALINA_HOME not found downloading." />
								<antcall target="dist:tools:retrieve:tomcat" />
								<unzip src="${tomcat.dest.file}" dest="${pt.dir}" />
							</then>
							<else>
								<echo message="LOCAL_CATALINA_HOME found ${local.tomcat.home}" />
							</else>
						</if>
					</else>
				</if>
			</then>
		</if>

		<available file="${mirth.dest.file}" property="mirth.tools.exists" />
		<!-- If mirth is required to build, then check for mirth in mirth.home, then check for in mirth in working directory, if not found then download it into this that directory.
				If found at any point set local.mirth.home to where it is found.  This can be passed to sub-projects so then can compile code against distribution.  This is especially important
				on AntHillPro server which will not have mirth present, thus will have to use a copy in the working area.  This also makes it easier to start the project, if the developer does
				not yet have mirth installed, build will download it and install it so build can proceed. -->
		<if>
			<equals arg1="${require.mirth}" arg2="true" />
			<then>
				<available file="${mirth.home}/lib/mirth-client-core.jar" property="rt.mirth.exists" />
				<if>
					<isset property="rt.mirth.exists" />
					<then>
						<property name="local.mirth.home" location="${mirth.home}" />
						<echo message="MIRTH_HOME exists ${mirth.home}" />
					</then>
					<else>
						<property name="local.mirth.home" location="${pt.dir}/mirth" />
						<available file="${local.mirth.home}/lib/mirth-client-core.jar" property="local.mirth.exists" />
						<echo message="MIRTH_HOME does not exist checking for LOCAL_MIRTH_HOME ${local.mirth.home}" />
						<if>
							<not>
								<isset property="local.mirth.exists" />
							</not>
							<then>
								<echo message="LOCAL_MIRTH_HOME not found downloading." />
								<antcall target="dist:tools:retrieve:mirth" />
								<unzip src="${mirth.dest.file}" dest="${local.mirth.home}" />
							</then>
							<else>
								<echo message="LOCAL_MIRTH_HOME found ${local.mirth.home}" />
							</else>
						</if>
					</else>
				</if>
			</then>
		</if>

		<available file="${axis.2.file}" property="axis.2.tools.exists" />
		<if>
			<equals arg1="${require.axis.2}" arg2="true" />
			<then>
				<available file="${axis.2.home}/lib/wsdl4j-1.6.2.jar" property="rt.axis.2.exists" />
				<if>
					<isset property="rt.axis.2.exists" />
					<then>
						<property name="local.axis.2.home" location="${axis.2.home}" />
						<echo message="AXIS_2_HOME exists ${axis.2.home}" />
					</then>
					<else>
						<property name="local.axis.2.home" location="${pt.dir}/${axis.2.relative.path}" />
						<available file="${local.axis.2.home}/lib/wsdl4j-1.6.2.jar" property="local.axis.2.exists" />
						<echo message="AXIS_2_HOME does not exist checking for LOCAL_AXIS_2_HOME ${local.axis.2.home}" />
						<if>
							<not>
								<isset property="local.axis.2.exists" />
							</not>
							<then>
								<echo message="LOCAL_AXIS_2_HOME not found downloading." />
								<antcall target="dist:tools:retrieve:axis.2" />
								<unzip src="${axis.2.file}" dest="${pt.dir}" />
							</then>
							<else>
								<echo message="LOCAL_AXIS_2_HOME found ${local.axis.2.home}" />
							</else>
						</if>
					</else>
				</if>
			</then>
		</if>
		
		<available file="${activemq.file}" property="activemq.tools.exists" />
		<if>
			<equals arg1="${require.activemq}" arg2="true" />
			<then>
				<available file="${activemq.home}/lib/activemq-console-5.3.2.jar" property="rt.activemq.exists" />
				<if>
					<isset property="rt.activemq.exists" />
					<then>
						<property name="local.activemq.home" location="${activemq.home}" />
						<echo message="ACTIVEMQ_HOME exists ${activemq.home}" />
					</then>
					<else>
						<property name="local.activemq.home" location="${pt.dir}/${activemq.relative.path}" />
						<available file="${local.activemq.home}/lib/activemq-console-5.3.2.jar" property="local.activemq.exists" />
						<echo message="ACTIVEMQ_HOME does not exist checking for LOCAL_ACTIVEMQ_HOME ${local.activemq.home}" />
						<if>
							<not>
								<isset property="local.activemq.exists" />
							</not>
							<then>
								<echo message="LOCAL_ACTIVEMQ_HOME not found downloading." />
								<antcall target="dist:tools:retrieve:activemq" />
								<unzip src="${activemq.file}" dest="${pt.dir}" />
							</then>
							<else>
								<echo message="LOCAL_ACTIVEMQ_HOME found ${local.activemq.home}" />
							</else>
						</if>
					</else>
				</if>
			</then>
		</if>
	</target>

	<target name="ivy:clean" description="Cleans up the ivy cache of this project and all sub-projects">
		<ivy:settings file="${ivy.settings.dir}/${ivy.settings.file}" />
		<ivy:cleancache />
		<ant inheritAll="false" inheritRefs="false" antfile="bda-ivy-2.0.0-build.xml" target="ivy-cleancache" dir="${bda-download.dir}">
			<property name="bda-utils.dir" value="${bda-utils.dir}" />
			<property name="lib.dir" value="${lib.dir}" />
			<property name="software.dir" value="${software.dir}" />
		</ant>
		<!--
		<ant inheritAll="false" inheritRefs="false" antfile="${caXchangeInboundService.build.file}" target="ivy-clean" dir="${caXchangeInboundService.base.dir}" />
		-->
	</target>

	<target name="validate:pre:build">
		<validate-pre-build />
	</target>

	<target name="build:all" description="Builds all the sub projects, putting artifacts in the project level target directory, used by distribution targets to make distributions" depends="
		validate:pre:build,
 		clean,
 		init,
		build:caXchangeInboundService,
		build:OpenClinicaConsumerService,
		build:integration-smoke-test,
		build:OpenClinicaWebSSOClient,
		build:CaXchangeConsumerService,
 		build:mirth-components,
		build:OpenClinicaPlugin,
 		database:prep
		">
	</target>

	<target name="build:mirth-components" depends="init" description="Call mirth-components build target to produce artifiacts">
		<ant inheritAll="false" inheritRefs="false" antfile="${mirth-components.build.file}" target="${mirth-components.build.target}" dir="${mirth-components.base.dir}">
			<property name="dist.dir" value="${mirth-components.dist.dir}" />			
			<property name="env.GLOBUS_LOCATION" value="${env.GLOBUS_LOCATION}" />
			<property name="no.deployment.validation" value="true" />
			<property name="tomcat.dir" value="${pt.dir}/${tomcat.binaries.relative.dir}" />
			<property name="globus.webapp" value="${caXchange.wsrf.war.name}" />
			<property name="build.compiler" value="extJavac" />
		</ant>
	</target>

	<target name="build:caXchangeInboundService" depends="init" description="Call caXchangeInboundService sub-project's build target to produce artifiacts">
		<!-- setting the property in the ant call overrides the property in the sub-project allowing the artifact to be produced where needed -->
		<ant inheritAll="false" inheritRefs="false" antfile="${caXchangeInboundService.build.file}" target="${caXchangeInboundService.build.target}" dir="${caXchangeInboundService.base.dir}">
			<property name="dist.dir" value="${caXchangeInboundService.dist.dir}" />
			<property name="env.GLOBUS_LOCATION" value="${env.GLOBUS_LOCATION}" />
			<property name="no.deployment.validation" value="true" />
			<property name="tomcat.dir" value="${pt.dir}/${tomcat.binaries.relative.dir}" />
			<property name="globus.webapp" value="${caXchange.wsrf.war.name}" />
			<property name="build.compiler" value="extJavac" />
		</ant>
	</target>

	<target name="build:OpenClinicaPlugin" depends="init" description="Call Open Clinica Plug in sub-project's build target to produce artifiacts">
		<!-- setting the property in the ant call overrides the property in the sub-project allowing the artifact to be produced where needed -->
		<ant inheritAll="false" inheritRefs="false" antfile="${OpenClinicaPlugin.build.file}" target="${OpenClinicaPlugin.build.target}" dir="${OpenClinicaPlugin.base.dir}">
			<property name="basedir" value="${OpenClinicaPlugin.base.dir}" />
			<property name="dist.dir" value="${OpenClinica.dist.dir}" />
			<property name="AXIS2_HOME" value="${local.axis.2.home}" />
			<property name="env.GLOBUS_LOCATION" value="${env.GLOBUS_LOCATION}" />
		</ant>
	</target>

	<target name="build:OpenClinicaWebSSOClient" depends="init" description="Call Open Clinica WebSSO Client sub-project's build target to produce artifiacts">
		<!-- setting the property in the ant call overrides the property in the sub-project allowing the artifact to be produced where needed -->
		<ant inheritAll="false" inheritRefs="false" antfile="${OpenClinicaWebSSOClient.build.file}" target="${OpenClinicaWebSSOClient.build.target}" dir="${OpenClinicaWebSSOClient.base.dir}">
			<property name="basedir" value="${OpenClinicaWebSSOClient.base.dir}" />
			<property name="dist.dir" value="${OpenClinicaWebSSO.dist.dir}" />
			<property name="env.GLOBUS_LOCATION" value="${env.GLOBUS_LOCATION}" />
		</ant>
	</target>

	<target name="build:OpenClinicaConsumerService" depends="init" description="Copy OpenClinicaConsumerService sub-project's contents to dist folder">
		<ant inheritAll="false" inheritRefs="false" antfile="${OpenClinicaConsumerService.build.file}" target="${OpenClinicaConsumerService.build.target}" dir="${OpenClinicaConsumerService.base.dir}">
			<property name="env.GLOBUS_LOCATION" value="${env.GLOBUS_LOCATION}" />
			<property name="no.deployment.validation" value="true" />
			<property name="globus.webapp" value="${openclinica.consumer.wsrf.war.name}" />
			<property name="dist.dir" value="${OpenClinicaConsumerService.dist.dir}" />
			<property name="tomcat.dir" value="${pt.dir}/${tomcat.binaries.relative.dir}" />
			<property name="build.compiler" value="extJavac" />
		</ant>
	</target>

	<target name="build:CaXchangeConsumerService" depends="init" description="Copy CaXchangeConsumerService sub-project's contents to dist folder">
		<copy todir="${CaXchangeConsumerService.dist.dir}">
			<fileset dir="${CaXchangeConsumerService.base.dir}" />
		</copy>
	</target>

	<target name="build:integration-smoke-test" depends="" description="Copy integration-smoke-test sub-project's contents to dist folder">
		<ant inheritAll="false" inheritRefs="false" antfile="${integration-smoke-test.build.file}" target="${integration-smoke-test.build.target}" dir="${integration-smoke-test.base.dir}">
			<property name="dist.dir" value="${integration-smoke-test.dist.dir}" />
			<property name="ext.globus.dir" value="${env.GLOBUS_LOCATION}" />
		</ant>
	</target>
	    
	<target name="dist" description="Makes all distributions: installer, upgrader and source" depends="
		build:all,
 		dist:installer,
 		dist:upgrader,
 		dist:src
        
		">
	</target>

	<target name="dist:src" description="Makes source distribution">
		<!-- Add tasks here to zip up src into a distribution, may require some additoinal properties for distribution name" -->
	</target>

	<target name="dist:tools:retrieve" description="Downloads binary applications from commonlibrary repository" depends="
		init,
 		dist:tools:retrieve:tomcat,
		dist:tools:retrieve:mirth,
 		dist:tools:retrieve:cagrid,
 		dist:tools:retrieve:axis.2,
		dist:tools:retrieve:activemq
		">
	</target>

	<target name="dist:tools:retrieve:tomcat" unless="tomcat.tools.exists" description="Downloads TOMCAT from binary repository and verifies checksum">
		<get src="${tomcat.src.url}" dest="${tomcat.dest.file}" />
		<get src="${tomcat.src.url}.MD5" dest="${tomcat.dest.file}.MD5" />
		<checksum file="${tomcat.dest.file}" verifyProperty="tomcat.cksum.ok" />
		<if>
			<equals arg1="${tomcat.cksum.ok}" arg2="true" />
			<then>
				<echo message="Downloaded tomcat sucessfully" />
			</then>
			<else>
				<fail message="Failed to download tomcat file sucessfully." />
			</else>
		</if>
	</target>

	<target name="dist:tools:retrieve:mirth" unless="mirth.tools.exists" description="Downloads mirth from binary repository and verifies checksum">
		<get src="${mirth.src.url}" dest="${mirth.dest.file}" />		
		<!-- Commented out the md5 check, should uncomment this portion after the binary and md5 are added in repository
		<get src="${mirth.src.url}.md5" dest="${mirth.dest.file}.MD5" />
		<checksum file="${mirth.dest.file}" verifyProperty="mirth.cksum.ok" />
		<if>
			<equals arg1="${mirth.cksum.ok}" arg2="true" />
			<then>
				<echo message="Downloaded mirth sucessfully" />
			</then>
			<else>
				<fail message="Failed to download mirth file sucessfully." />
			</else>
		</if>
		-->
	</target>

	<target name="dist:tools:retrieve:axis.2" unless="local.axis.2.exists" description="Downloads AXIS 2 from binary repository and verifies checksum">
		<get src="${axis.2.src.url}" dest="${axis.2.file}" />
		<get src="${axis.2.src.md5.url}" dest="${axis.2.file}.MD5" />		
	</target>
	
	<target name="dist:tools:retrieve:activemq" unless="local.activemq.exists" description="Downloads ACTIVEMQ from binary repository and verifies checksum">
		<get src="${activemq.src.url}" dest="${activemq.file}" />
		<!--<get src="${activemq.src.md5.url}" dest="${activemq.file}.MD5" />		-->
	</target>

	<target name="dist:tools:retrieve:cagrid" unless="cagrid-libs.tools.exists" description="Downloads CAGRID related libraries">
		<get src="${cagrid-libs.src.url}" dest="${cagrid-libs.dest.file}" />
		<get src="${cagrid-base-war.src.url}" dest="${cagrid-base-war.dest.file}" />
	</target>

	<!-- consider adding build:all, dist:tools:retrieve to depends attribute  -->
	<target name="dist:installer:prep" depends="build:all, dist:tools:retrieve" description="Copies artifacts not generated by sub-project builds into the install distribution area">

		<!-- Copy db-install and db-upgrade scripts from source into distribution area. The db files need to be under db-[install/upgard]/${database.type}. Because of this fact these files were not moved to the macro. -->
		<copy todir="${db.caxchange-install.dist.dir}" overwrite="true">
			<fileset dir="${db.caxchange-install.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${db.caxchange-upgrade.dist.dir}" overwrite="true">
			<fileset dir="${db.caxchange-upgrade.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${db.llt-install.dist.dir}" overwrite="true">
			<fileset dir="${db.llt-install.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${db.llt-upgrade.dist.dir}" overwrite="true">
			<fileset dir="${db.llt-upgrade.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>

		<dist-prep />
		<copy todir="${tools.dist.dir}">
			<fileset dir="${download.dir}">
			</fileset>
		</copy>
	</target>

	<target name="dist:installer" depends="dist:installer:prep" description="Produces zip file based on installer distribution area. Zip is used by deploy:remote:* or external installations">
		<delete file="${dist.dir}/${caXchange.install.zip.file}" />
		<!-- Set environment name to external -->
		<delete file="${dist.exploded.dir}/upgrade.properties" />
		<replaceregexp file="${dist.exploded.dir}/install.properties" byline="true" match="^(env.name)=.*" replace="\1=external" />
		<obfuscate-properties-file properties.file="${dist.exploded.dir}/install.properties" required.property.list="application.base.path.linux,application.base.path.windows,database.system.user,database.system.password,database.server,database.port,database.name,database.user,database.password,mail.smtp.host,jboss.server.hostname" optional.property.list="ldap.url,ldap.basedn" delete.property.list="exclude.jboss.backup" />
		<zip destfile="${dist.dir}/${caXchange.install.zip.file}" basedir="${dist.exploded.dir}" />
	</target>
	<!--
	<target name="dist:upgrader:prep" depends="
		build:all
		" description="Copies artifacts not generated by sub-project builds into the install distribution area">
	-->
	<!-- for DAC Upgrades  -->
	<!-- consider adding build:all,dist:tools:retrieve to depends attribute  -->
	<target name="dist:upgrader:prep" depends="build:all,dist:tools:retrieve" description="Copies artifacts not generated by sub-project builds into the install distribution area">
		<!-- Copy db-upgrade scripts from source into distribution area. The db files need to be under db-upgrade/${database.type}. This has not been moved to the macro because the source and dest structure may not be the same and thus this would need to be custom. -->
		<copy todir="${db.caxchange-upgrade.dist.dir}" overwrite="true">
			<fileset dir="${db.caxchange-upgrade.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${db.llt-upgrade.dist.dir}" overwrite="true">
			<fileset dir="${db.llt-upgrade.src.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<!-- For non DAC upgrades
		<dist-prep
			copy.tools.flag="N"
			default.target="upgrade"
			/>
		-->
		<!-- For DAC upgrades -->
		<dist-prep copy.tools.flag="Y" default.target="upgrade" />

	</target>

	<target name="dist:upgrader" depends="dist:upgrader:prep" description="Produces zip file based on installer distribution area. Zip is used by deploy:remote:* or external installations">
		<delete file="${dist.dir}/${caXchange.upgrade.zip.file}" />
		<!-- Set environment name to external -->
		<copy todir="${dist.exploded.dir}" overwrite="true">
			<fileset dir="${build.dir}">
				<include name="upgrade.properties" />
			</fileset>
		</copy>
		<delete file="${dist.exploded.dir}/install.properties" />
		<replaceregexp file="${dist.exploded.dir}/upgrade.properties" byline="true" match="^(env.name)=.*" replace="\1=external" />

		<obfuscate-properties-file properties.file="${dist.exploded.dir}/upgrade.properties" comment.property.list="application.base.path.windows,application.base.path.linux,jboss.relative.path,tomcat.relative.path,mirth.relative.path" uncomment.property.list="application.base.path,tomcat.home,mirth.home,jboss.home" required.property.list="application.base.path,jboss.home,jboss.server.name,tomcat.home,mirth.home" optional.property.list="" delete.property.list="" />
		<replaceregexp file="${dist.exploded.dir}/build.xml" byline="true" match="(&lt;property name=&quot;properties.file&quot;\s+value=&quot;).*(&quot;\s*\/&gt;)" replace="\1upgrade.properties\2" />
		<zip destfile="${dist.dir}/${caXchange.upgrade.zip.file}" basedir="${dist.exploded.dir}" />

	</target>

	<target name="dist:upgrade:tier:db" depends="dist:installer:prep">
		<delete file="${dist.dir}/${caXchange.install.name}_${caXchange.version}-db.zip" />
		<zip destfile="${dist.dir}/${caXchange.install.name}_${caXchange.version}-db.zip">
			<zipfileset dir="${db.caxchange-install.dist.dir}" prefix="${db.caxchange-install.dist.relative.dir}" />
			<zipfileset dir="${db.llt-install.dist.dir}" prefix="${db.llt-install.dist.relative.dir}" />
			<zipfileset dir="${db.caxchange-upgrade.dist.dir}" prefix="${db.caxchange-upgrade.dist.relative.dir}" />
			<zipfileset dir="${db.llt-upgrade.dist.dir}" prefix="${db.llt-upgrade.dist.relative.dir}" />
			<!-- not needed for this target
			<zipfileset dir="${caXchangeInboundService.dist.dir}" prefix="${caXchangeInboundService.dist.relative.dir}"/>
			<zipfileset dir="${tools.dist.dir}" prefix="${tools.dist.relative.dir}"/>
			<zipfileset dir="${common.dist.dir}" prefix="${common.dist.relative.dir}"/>
			-->
			<zipfileset dir="${bda-utils.dir}" prefix="bda-utils" />
			<zipfileset dir="${dist.exploded.dir}">
				<include name="build.xml" />
				<include name="install.properties" />
				<include name="properties.template" />
				<include name="project.properties" />
			</zipfileset>
			<!--  might want to add this
			<zipfileset dir="${build.dir}">
				<include name="local.properties" />
			</zipfileset>
			-->
		</zip>
	</target>

	<target name="dist:upgrade:tier:tomcat" depends="dist:installer:prep">
		<delete file="${dist.dir}/${caXchange.install.name}_${caXchange.version}-tomcat.zip" />
		<zip destfile="${dist.dir}/${caXchange.install.name}_${caXchange.version}-tomcat.zip">
			<zipfileset dir="${caXchangeInboundService.dist.dir}" prefix="${caXchangeInboundService.dist.relative.dir}" />
			<zipfileset dir="${tools.dist.dir}" prefix="${tools.dist.relative.dir}">
				<include name="*tomcat*" />
			</zipfileset>
			<zipfileset dir="${common.dist.dir}" prefix="${common.dist.relative.dir}" />
			<zipfileset dir="${bda-utils.dir}" prefix="bda-utils" />
			<zipfileset dir="${dist.exploded.dir}">
				<include name="build.xml" />
				<include name="install.properties" />
				<include name="properties.template" />
				<include name="project.properties" />
			</zipfileset>
		</zip>
	</target>

	<target name="dist:upgrade:tier" depends="
		dist:upgrade:tier:db,
 		dist:upgrade:tier:tomcat
		" />

	<target name="deploy:local:install" depends="build:all,dist:installer:prep" description="Installs and configures the application and required binaries and re-creates the datbase  on the local machine. Used for developer desktops and ci environments.">
		<!--
		  * Requires a database installation.
		  * Will use the target from install.xml specified in ${install.target} (defaults to install unless passed in on command line).
		  * If you want properties to be used at install time they must be included in a proeprties file.
		  * Calls ant from exec task to ensure properties are do not carry over from current ant runtime and also to emulate a manual install.
		  * This target will use differnt properties based on linux (linux-install.properties) or windows (windows-install.properties) installs.
		  * It only supports using those properties files for now, so if you want to change install time properites edit these files.
		-->
		<deploy-local target.name="${install.target}" />
	</target>

	<target name="deploy:local:upgrade" depends="build:all,dist:upgrader:prep" description="Upgrades and configures the application and database  on the local machine. Used for developer desktops and ci environments.">
		<!--
		  * Requires a database installation.
		  * Will use the target from install.xml specified in ${upgrade.target} (defaults to install unless passed in on command line).
		  * Calls ant from exec task to ensure properties are do not carry over from current ant runtime and also to emulate a manual install, if you want properties to be used at install time they must be included in a proeprties file.
		  * This target will use differnt properties based on linux (linux-upgrade.properties) or windows (windows-upgrade.properties) installs.
		  * It only supports using those properties files for now, so if you want to change install time properites edit these files.
		-->
		<deploy-local target.name="${upgrade.target}" properties.file="${upgrade.properties.file}" />
	</target>

	<target name="deploy:remote:install" description="Installs and configures the application and required binaries and re-creates the datbase  on a remote machine. Used for NCI tiers (dev, qa, stg, prod)" depends="
		build:all,
		dist:installer
		">
		<!--
		  * Will use the target from install.xml specified in ${install.target} (defaults to install unless passed in on command line).
		  * Requires specifying -Dproperties.file=@file@ on the command line to point installer to correct enviornment to install into.
		  * Calls ant from exec task to ensure properties are do not carry over from current ant runtime and also to emulate a manual install, if you want properties to be used at install time they must be included in a proeprties file.
		-->
		<!-- Call macro to deploy files on desired server -->
		<deploy-files dist.file="${caXchange.install.zip.file}" />
		<!-- SSH to machine ant run ant command line to install application -->
		<remote-ssh remotesshcommand=". .bash_profile;cd ${ssh.dir.temp}; ant -Dproperties.file=${properties.file.name} -Dforce.reinstall=true ${install.target}" />
	</target>

	<target name="deploy:remote:upgrade" description="Installs and configures the application and required binaries and re-creates the datbase  on a remote machine. Used for NCI tiers (dev, qa, stg, prod)" depends="
		build:all,
		dist:upgrader
		">
		<!--
		  * Will use the target from install.xml specified in ${upgrade.target} (defaults to upgrade unless passed in on command line).
		  * Requires specifying -Dproperties.file=@file@ on the command line to point installer to correct enviornment to install into.
		  * Calls ant from exec task to ensure properties are do not carry over from current ant runtime and also to emulate a manual install, if you want properties to be used at install time they must be included in a proeprties file.
		-->
		<!-- Call macro to deploy files on desired server -->
		<deploy-files dist.file="${caXchange.upgrade.zip.file}" />
		<!-- SSH to machine ant run ant command line to install application -->
		<remote-ssh remotesshcommand=". .bash_profile;cd ${ssh.dir.temp}; ant -Dproperties.file=${properties.file.name} -Dforce.reinstall=true ${upgrade.target}" />
	</target>


	<target name="deploy:remote:ahp" description="Installs and configures the application and required binaries and re-creates the datbase  on a remote machine. Used for NCI tiers (dev, qa, stg, prod)" depends="
			dist:upgrader
			">
		<!--
			  * Will use the target from install.xml specified in ${upgrade.target} (defaults to upgrade unless passed in on command line).
			  * Requires specifying -Dproperties.file=@file@ on the command line to point installer to correct enviornment to install into.
			  * Calls ant from exec task to ensure properties are do not carry over from current ant runtime and also to emulate a manual install, if you want properties to be used at install time they must be included in a proeprties file.
			-->
		<!-- Call macro to deploy files on desired server -->
		<deploy-files dist.file="${caXchange.upgrade.zip.file}" />
		<!-- SSH to machine ant run ant command line to install application -->
		<remote-ssh remotesshcommand=". .bash_profile;cd ${ssh.dir.temp}; ant -Dproperties.file=${properties.file.name} -Dforce.reinstall=true ${upgrade.target}" />
	</target>

	<target name="deploy:remote:upgrade:db" depends="
		build:all,
		dist:upgrade:tier:db
		">
		<deploy-files ssh.user="${db.ssh.server.username}" ssh.host="${db.ssh.server.hostname}" remote.directory.property.name="db.ssh.dir.temp" dist.file="${caXchange.install.name}_${caXchange.version}-db.zip" />
	</target>

	<target name="deploy:remote:upgrade:tomcat" depends="
		build:all,
		dist:upgrade:tier:tomcat
		">
		<deploy-files ssh.user="${tomcat.ssh.server.username}" ssh.host="${tomcat.ssh.server.hostname}" remote.directory.property.name="tomcat.ssh.dir.temp" dist.file="${caXchange.install.name}_${caXchange.version}-tomcat.zip" />
	</target>

	<target name="usage" description="Explains how to use this build script">
		<echo message="To run a remote upgrade type: ant deploy:remote:upgrade -Dproperties.file=[path to environment proeprty file]" />
	</target>

	<target name="report:grand" depends="dist:installer:prep" description="Generates target flow diagrams for build files">
		<!-- Temporary fix to make grand work for install.xml -->

		<report-grand build.file.location="build.xml" output.file.dir="${grand.rpt.dir}" output.file.name="generic-root-build.xml" />
		<report-grand build.file.location="${dist.exploded.dir}/build.xml" output.file.dir="${grand.rpt.dir}" output.file.name="generic-root-install.xml" />
	</target>

	<target name="test:all" description="Runs test target for all sub-projects" depends="
		clean,
		init,
		test:mirth-components,
		test:caXchangeInboundService
		">
	</target>

	<target name="test:mirth-components" depends="init" description="Calls test target for sub-project">
		<!--
		<ant inheritAll="false" inheritRefs="false" antfile="${mirth-components.test.file}"
			target="test"
			dir="${mirth-components.base.dir}" >
			<property name="dist" value="${mirth-components.dist.dir}" />
		</ant>
		-->
	</target>

	<target name="test:caXchangeInboundService" depends="init" description="Calls test target for sub-project">
		<ant inheritAll="false" inheritRefs="false" antfile="${caXchangeInboundService.test.file}" target="test" dir="${caXchangeInboundService.base.dir}">
			<property name="dist.dir" value="${caXchangeInboundService.dist.dir}" />
		</ant>
	</target>

	<target name="static-analysis:all" description="Runs static-analysis target for all sub-projects" depends="
		clean,
		init,
		static-analysis:mirth-components,
		static-analysis:caXchangeInboundService
		">
	</target>

	<target name="static-analysis:mirth-components" depends="init" description="Calls static-analysis target for sub-project">
		<!--
		<ant inheritAll="false" inheritRefs="false" antfile="${mirth-components.build.file}"
			target="static-analysis"
			dir="${mirth-components.base.dir}" >
			<property name="dist" value="${mirth-components.dist.dir}" />
		</ant>
		-->
	</target>

	<target name="static-analysis:caXchangeInboundService" depends="init" description="Calls static-analysis target for sub-project">
		<ant inheritAll="false" inheritRefs="false" antfile="${caXchangeInboundService.build.file}" target="static-analysis" dir="${caXchangeInboundService.base.dir}">
			<property name="dist.dir" value="${caXchangeInboundService.dist.dir}" />
		</ant>
	</target>

	<target name="continuous-integration" description="calls wrapper targets for continuous integration build" depends="
		build:all,
		static-analysis:all
		">
	</target>

	<target name="init:ivy" description="Initializes ivy-repo.based on ivy definition file and ivy settings file">
		<mkdir dir="${local.repo.dir}" />
		<property name="ivy.dep.file" value="${ivy.settings.dir}/ivy-test.xml" />
		<ivy:settings file="${ivy.settings.dir}/ivy.settings.xml" />
	</target>


	<target name="ivy-resolve-all" depends="init:ivy" description="Downloads all libraries included in the ivy definition file from ivy into local lib directory">
		<ivy:resolve refresh="true" />
	</target>

	<target name="report:ivy" description="Runs ivy reports on all dependencies in the ivy defnintion file, also produces dependency diagrams" depends="
		ivy-resolve-all
		">
		<property name="ivy.report.dir" value="${reports.dir}/ivy" />
		<delete dir="${ivy.report.dir}" />
		<mkdir dir="${ivy.report.dir}" />
		<ivy:report outputpattern="target/reports/ivy/[organisation]-[module]-[conf].[ext]" dot="true" graph="false" />
		<util-dot-on-dir dot-file.dir="target/reports/ivy" />
	</target>

	<target name="ivy:module:add2repo">
		<!-- you would want to use this value instead and you can get rid of the mkdir below
		<property name="ivy-repo.base.dir" location="${software.dir}/../../ivy-repo"/>
		-->
		<mkdir dir="${user.home}/tmp" />
		<ivy-module-add2repo ivy-repo.base.dir="${user.home}/tmp/ivy-repo" ivy.add.org="ncicb" ivy.add.module="ssaksa-test-module3" ivy.add.version="0.1.0" ivy.add.module.src.dir="${build.dir}" ivy.add.module.src.file.list="build.xml" ivy.add.xml.src.location="${build.dir}/install.xml" />
	</target>

	<target name="database:prep" description="Copies db files with filtering">
		<copy todir="${db.root.dist.dir}" overwrite="true">
			<fileset dir="${db.root.src.dir}">
				<include name="**/*" />
			</fileset>
			<filterset refid="buildFilterSet" />
		</copy>
	</target>
</project>
