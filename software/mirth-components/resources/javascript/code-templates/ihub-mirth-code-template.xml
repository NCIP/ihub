<list>
  <com.webreach.mirth.model.CodeTemplate>
    <id>cff8ac93-a738-452d-8b07-3fe56b4f23ea</id>
    <name>Invoke Target Grid and Compile Response</name>
    <tooltip></tooltip>
    <code>function delegateSingleTargetRequest(varServiceType, varTargetInvocationStrategy, varBusinessMessageXMLSchemaDefinition, varMessageID){
	var	varTargetDetailsCode = varTargetInvocationStrategy.getServiceProviderName();
	
	try{
		//logger.info(varTargetDetailsCode+&quot; XML schema definition: &quot;+varBusinessMessageXMLSchemaDefinition);
		if (varBusinessMessageXMLSchemaDefinition == undefined){
			varBusinessMessageXMLSchemaDefinition = &quot;&quot;;
		}

		var gridInvocationResult = varTargetInvocationStrategy.invokeGridService(false);

		if(gridInvocationResult.isFault()){		
			if(gridInvocationResult.isRetry()){
				var retryAttempt=0;
				var totalRetryAttempts = globalMap.get(&quot;target.grid.service.retry.attempts&quot;);
				for (retryAttempt=0; retryAttempt&lt;totalRetryAttempts; retryAttempt++)
				{
					logger.info(varTargetDetailsCode+&quot; Retry Attempt: &quot;+retryAttempt);
					gridInvocationResult = varTargetInvocationStrategy.invokeGridService(false);
					if(gridInvocationResult.isFault()){
						continue;
					} else {
						insertCompiledTargetResponse(createSuccessResponseXML(gridInvocationResult, varTargetDetailsCode, varBusinessMessageXMLSchemaDefinition), 
							varTargetDetailsCode, globalMap.get(&quot;target.response.status.successful&quot;), varMessageID);
						break;
					}
				}
			} else {
				insertCompiledTargetResponse(createErrorResponseXML(gridInvocationResult.getInvocationException(), varTargetDetailsCode), 
					varTargetDetailsCode, globalMap.get(&quot;target.response.status.fault&quot;), varMessageID);
			}
		} else {
			insertCompiledTargetResponse(createSuccessResponseXML(gridInvocationResult, varTargetDetailsCode, varBusinessMessageXMLSchemaDefinition), 
					varTargetDetailsCode, globalMap.get(&quot;target.response.status.successful&quot;), varMessageID);
		}		

	} catch (error) {	
		logger.error(&quot;EXCEPTION OCCURED IN MIRTH DURING &quot;+varTargetDetailsCode+&quot; INVOCATION: &quot;+error);
		insertCompiledTargetResponse(createErrorResponseXML(new Packages.java.lang.Exception(error), varTargetDetailsCode), 
			varTargetDetailsCode, globalMap.get(&quot;target.response.status.fault&quot;), messageID);
	}
}



function delegateSynchronousRequest(varServiceType, varTargetInvocationStrategy, varMessageID, varExternalID, varOperationName, varBusinessMessageXMLSchemaDefinition){
	var	varTargetDetailsCode = varTargetInvocationStrategy.getServiceProviderName();
	var isFailureOverallResponse = false;
	var overallResponseString;
	var generateResponseBean = new Packages.gov.nih.nci.ihub.writer.ncies.common.GenerateResponseBean();
	try{
		if (varBusinessMessageXMLSchemaDefinition == undefined){
			varBusinessMessageXMLSchemaDefinition = &quot;&quot;;
		}
		gridInvocationResult = varTargetInvocationStrategy.invokeGridService(false);

		if(gridInvocationResult.isFault()){		
			if(gridInvocationResult.isRetry()){
				var retryAttempt=0;
				var totalRetryAttempts = globalMap.get(&quot;target.grid.service.retry.attempts&quot;);
				for (retryAttempt=0; retryAttempt&lt;totalRetryAttempts; retryAttempt++)
				{
					logger.info(varTargetDetailsCode+&quot; Retry Attempt: &quot;+retryAttempt);
					gridInvocationResult = varTargetInvocationStrategy.invokeGridService(false);
					if(gridInvocationResult.isFault()){
						isFailureOverallResponse = true;
						continue;
					} else {
						break;
					}
				}
			} else {
				isFailureOverallResponse = true;
			}
		}		
		var overallResponse = generateResponseBean.generateResponseFromTargetResponse(varExternalID, 
								varMessageID, generateResponseBean.createOutputDocument(varTargetDetailsCode, varOperationName, varBusinessMessageXMLSchemaDefinition, gridInvocationResult));
		//var overallResponse = generateResponseBean.createOutputDocument(varTargetDetailsCode, varOperationName, varBusinessMessageXMLSchemaDefinition, gridInvocationResult)	
		overallResponseString = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(overallResponse);
		updateMessageServiceResponseInDB(isFailureOverallResponse, &quot;&quot;, varMessageID, globalMap.get(&quot;request.message.status.responsereturned&quot;));

	} catch (error) {	
		logger.error(&quot;EXCEPTION OCCURED IN MIRTH DURING &quot;+varTargetDetailsCode+&quot; INVOCATION: &quot;+error);
		
		gridInvocationResult = new Packages.gov.nih.nci.ihub.writer.ncies.common.GridInvocationResult(true, createErrorResponseNode(new Packages.java.lang.Exception(error), varTargetDetailsCode), false);
		
		var overallResponse = generateResponseBean.generateResponseFromTargetResponse(varExternalID, 
								varMessageID, generateResponseBean.createOutputDocument(varTargetDetailsCode, varOperationName, varBusinessMessageXMLSchemaDefinition, gridInvocationResult));		
		overallResponseString = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(overallResponse);
		updateMessageServiceResponseInDB(true, &quot;&quot;, varMessageID, globalMap.get(&quot;request.message.status.responsereturned&quot;));
	}
	return overallResponseString;
}


function delegateTargetRollbackRequest(varServiceType, varTargetInvocationStrategyList, varMessageID){
	for(i=0; i&lt;varTargetInvocationStrategyList.size(); i++) {	
		
		varTargetInvocationStrategy = varTargetInvocationStrategyList.get(i);
		var	varTargetDetailsCode = varTargetInvocationStrategy.getServiceProviderName();
		logger.info(&quot;Sending &quot;+ varServiceType +&quot; ROLLBACK to &quot;+varTargetDetailsCode);
		try{	
			var gridInvocationResult = varTargetInvocationStrategy.invokeGridService(true);

		} catch (error) {	
			logger.error(&quot;EXCEPTION OCCURED IN MIRTH DURING &quot;+varTargetDetailsCode+&quot; INVOCATION: &quot;+error);
			insertCompiledTargetResponse(createErrorResponseXML(new Packages.java.lang.Exception(error), varTargetDetailsCode), 
				varTargetDetailsCode, globalMap.get(&quot;target.response.status.fault&quot;), messageID);
		}
	}
}



//By using the varRequestXMLSchemaDefinition, and undefined value is getting set in the aggregated response. As a work around, replacing 
// varRequestXMLSchemaDefinition with an empty string temporarily.
function createSuccessResponseXML(varGridInvocationResult, varTargetDetailCode, varRequestXMLSchemaDefinition){
	var generateResponseBean = new Packages.gov.nih.nci.ihub.writer.ncies.common.GenerateResponseBean();
	var gridInvocationResultDocument = generateResponseBean.createOutputDocument(varTargetDetailCode, new Packages.java.lang.String(&quot;&quot;),
			varRequestXMLSchemaDefinition, varGridInvocationResult);
	var successResponseXML = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(gridInvocationResultDocument);
	return successResponseXML;
}

function createErrorResponseXML(varException, varTargetDetailCode){
	var generateResponseBean = new Packages.gov.nih.nci.ihub.writer.ncies.common.GenerateResponseBean();
	var gridInvocationResultDocument = generateResponseBean.createErrorDocument(varTargetDetailCode, new Packages.java.lang.String(&quot;&quot;),
			 varException);
	var errorResponseXML = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(gridInvocationResultDocument);
	return errorResponseXML;
}


function createErrorResponseNode(varException, varTargetDetailCode){
	var generateResponseBean = new Packages.gov.nih.nci.ihub.writer.ncies.common.GenerateResponseBean();
	var gridInvocationResultDocument = generateResponseBean.createErrorDocument(varTargetDetailCode, new Packages.java.lang.String(&quot;&quot;),
			 varException);	
	return gridInvocationResultDocument;
}


function insertCompiledTargetResponse(varResponseXML, varTargetDetailCode, varTargetResponseStatus, varMessageID){
	logger.info(varTargetDetailCode+ &quot; Response XML: &quot;+varResponseXML);		
	//var dbConn = DatabaseConnectionFactory.createDatabaseConnection(&apos;org.postgresql.Driver&apos;,&apos;jdbc:postgresql://localhost:5432/mirth&apos;,&apos;mirthadmin&apos;,&apos;changeme&apos;);
	var dbConn = getIHubDatabaseConnection();

	var prepStatement = &quot;INSERT INTO COMPILED_TARGET_RESPONSE (MESSAGE_ID, TARGET_DETAILS, COMPILED_RESPONSE, TARGET_RESPONSE_STATUS, TIME_COMPLETED) VALUES(?,?,?,?,to_timestamp(?, &apos;YYYY-MM-DD HH24:MI:SS&apos;))&quot;;
	var params = new Packages.java.util.ArrayList();
	params.add(varMessageID);
	params.add(varTargetDetailCode);
	params.add(varResponseXML);
	params.add(varTargetResponseStatus);
	params.add(DateUtil.getCurrentDate(&quot;yyyy-MM-dd HH:mm:ss&quot;));

	dbConn.executeUpdate(prepStatement, params);
	dbConn.close();	
}


function insertIncomingMessageInDB(varMessageID, varBusinessMessagePayload, varMessageStatus, varSchemaDefinition, varMetadata){	
	var dbConn = getIHubDatabaseConnection();
	var prepStatement = &quot;INSERT INTO MESSAGE (MESSAGE_ID, PAYLOAD, MESSAGE_STATUS, TIME_RECEIVED, SCHEMA_DEFINITION, METADATA) VALUES(?, ?, ?, to_timestamp(?, &apos;YYYY-MM-DD HH24:MI:SS&apos;), ?, ?)&quot;;
	var params = new Packages.java.util.ArrayList();
	params.add(varMessageID);
	params.add(varBusinessMessagePayload);
	params.add(varMessageStatus);
	params.add(DateUtil.getCurrentDate(&quot;yyyy-MM-dd HH:mm:ss&quot;));
	params.add(varSchemaDefinition);
	params.add(varMetadata);
	dbConn.executeUpdate(prepStatement, params);
	dbConn.close();	
}


function getCompiledResponseResultsFromDB(varMessageID){	
	var dbConn = getIHubDatabaseConnection();
	var resultSet = dbConn.executeCachedQuery(&quot;SELECT compiled_target_response.compiled_target_response_id AS compiled_target_response_compiled_target_response_id, compiled_target_response.message_id AS compiled_target_response_message_id, compiled_target_response.target_details AS compiled_target_response_target_details, compiled_target_response.compiled_response AS compiled_target_response_compiled_response, compiled_target_response.target_response_status AS compiled_target_response_target_response_status, compiled_target_response.time_completed AS compiled_target_response_time_completed FROM compiled_target_response where message_id=&apos;&quot;+varMessageID+&quot;&apos;&quot;);
	//logger.info(&quot;Compiled Result Set Size: &quot;+resultSet.size());
	dbConn.close();
	return resultSet;
}


// This function is called by: aggregateBroadcastResponse().
function updateMessageServiceResponseInDB(varIsFailureOverallResponse, varOverallResponseString, varMessageID, varMessageStatus){
	var overallResponseStatus = globalMap.get(&quot;overall.response.status.success&quot;);
	if(varIsFailureOverallResponse){
		overallResponseStatus = globalMap.get(&quot;overall.response.status.failure&quot;);
	}
	//var overallResponseString = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(varOverallResponse);
	//logger.info(&quot;Overall Response String: &quot;+varOverallResponseString);
	var dbConn = getIHubDatabaseConnection();
	var prepStatement = &quot;UPDATE MESSAGE SET MESSAGE_STATUS=?, OVERALL_RESPONSE_DATA=?, OVERALL_RESPONSE_STATUS=?, TIME_COMPLETED=to_timestamp(?, &apos;YYYY-MM-DD HH24:MI:SS&apos;) WHERE MESSAGE_ID=?&quot;;
	var params = new Packages.java.util.ArrayList();
	params.add(varMessageStatus);
	params.add(varOverallResponseString);
	params.add(overallResponseStatus);
	params.add(DateUtil.getCurrentDate(&quot;yyyy-MM-dd HH:mm:ss&quot;));
	params.add(varMessageID);
	dbConn.executeUpdate(prepStatement, params);
	dbConn.close();		
}


function retrieveOverallBroadcastResponseFromDB(varMessageID){
	var overallResponseString;
	try{
		var dbConn = getIHubDatabaseConnection();
		var overallResponseSQL = &quot;SELECT message.overall_response_data AS message_overall_response_data FROM message WHERE message.message_id=&apos;&quot;+varMessageID+&quot;&apos; AND message.message_status=&apos;&quot;+globalMap.get(&apos;request.message.status.processed&apos;)+&quot;&apos;&quot;;
		var overallResponseResults = dbConn.executeCachedQuery(overallResponseSQL);

		var totalSecondsElapsed = 0;
		while (overallResponseResults.size() &lt; 1) {
			Packages.java.lang.Thread.sleep(1000);
			overallResponseResults = dbConn.executeCachedQuery(overallResponseSQL);
			totalSecondsElapsed++;
			if(totalSecondsElapsed &gt;= 62){			
				break;
			}
		}
		if(overallResponseResults.next()){
			overallResponseString = overallResponseResults.getString(&quot;message_overall_response_data&quot;);			
			updateMessageServiceStatusInDB(globalMap.get(&quot;request.message.status.responsereturned&quot;), varMessageID);
			dbConn.close();			
		} else {
			//initiate code to put some error response message back in the queue
		}
		return overallResponseString;

	} catch (error) {
		logger.error(&quot;Error occured in Retrieve Response From Database: &quot;+error);
	}
}

</code>
    <type>FUNCTION</type>
    <scope>2</scope>
  </com.webreach.mirth.model.CodeTemplate>
  <com.webreach.mirth.model.CodeTemplate>
    <id>d55e91c7-714f-445e-a3eb-6a2c772d81c0</id>
    <name>getIHubDatabaseConnection</name>
    <tooltip>Returns database connection for caBIG Integration Hub</tooltip>
    <code>function getIHubDatabaseConnection(){	
	var dbConn = DatabaseConnectionFactory.createDatabaseConnection(globalMap.get(&quot;database.driver&quot;),
					globalMap.get(&quot;database.url&quot;),globalMap.get(&quot;database.username&quot;),globalMap.get(&quot;database.password&quot;));	
	return dbConn;
}</code>
    <type>FUNCTION</type>
    <scope>2</scope>
  </com.webreach.mirth.model.CodeTemplate>
  <com.webreach.mirth.model.CodeTemplate>
    <id>40480fca-b111-42e9-81a6-b460f6bbe670</id>
    <name>aggregateBroadcastResponse</name>
    <tooltip>Generic Aggregator Function that aggregates responses from one or more suite target services</tooltip>
    <code>function aggregateBroadcastResponse(varServiceType, varTargetInvocationStrategy, varBusinessMessagePayload, varConsumerIdentifier, varMessageID){
	try{
		var activeDestinationCount = globalMap.get(varServiceType+&quot;.active.destination.count&quot;);
		//logger.info(&quot;Active Destination Count: &quot;+activeDestinationCount);

		var compiledResponseResultSet = getCompiledResponseResultsFromDB(varMessageID);

		var totalSecondsElapsed = 0;
		while (compiledResponseResultSet.size() &lt; activeDestinationCount) {
			Packages.java.lang.Thread.sleep(1000);
			compiledResponseResultSet = getCompiledResponseResultsFromDB(varMessageID);
			totalSecondsElapsed++;
			if(totalSecondsElapsed &gt;= 60){
				//initiate the code for timeout here
				break;
			}
		}

		var responseArrayList = new Packages.java.util.ArrayList();
		var potentialRollbackInvocationStrategyList = new Packages.java.util.ArrayList();
		var isFailureOverallResponse = false;
		if (compiledResponseResultSet.size() == 0){
			isFailureOverallResponse = true;
		}
		while(compiledResponseResultSet.next()){
			var compiledResponseStringToDOMDocument = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.stringToDOMDocument(
				compiledResponseResultSet.getString(&quot;compiled_target_response_compiled_response&quot;));
			responseArrayList.add(compiledResponseStringToDOMDocument);
			var compiledTargetResponseStatus = compiledResponseResultSet.getString(&quot;compiled_target_response_target_response_status&quot;);
			if(compiledTargetResponseStatus == globalMap.get(&quot;target.response.status.fault&quot;)){
				isFailureOverallResponse = true;
			} else {			
				varTargetInvocationStrategy.setSubject(globalMap.get(&quot;subject&quot;+varMessageID));
				varTargetInvocationStrategy.setServiceURL(globalMap.get(compiledResponseResultSet.getString(&quot;compiled_target_response_target_details&quot;)+&quot;.&quot;+varServiceType+&quot;.url&quot;));
				varTargetInvocationStrategy.setPayload(varBusinessMessagePayload);
				varTargetInvocationStrategy.setServiceProviderName(compiledResponseResultSet.getString(&quot;compiled_target_response_target_details&quot;));

				potentialRollbackInvocationStrategyList.add(varTargetInvocationStrategy);

				varTargetInvocationStrategy = varTargetInvocationStrategy.getClass().newInstance();
			}
		}

		if(isFailureOverallResponse){
			//send rollbacks to targets that executed successfully
			delegateTargetRollbackRequest(varServiceType, potentialRollbackInvocationStrategyList, varMessageID);	
		}

		var aggregatedResponseBuilder = new Packages.gov.nih.nci.ihub.writer.ncies.common.AggregatedResponseBuilder();
		var aggregatedResponse = aggregatedResponseBuilder.buildAggregatedDocument(responseArrayList, false);
		var generateResponseBean = new Packages.gov.nih.nci.ihub.writer.ncies.common.GenerateResponseBean();
		var overallResponse = generateResponseBean.generateResponseFromAggregatedResponse(varConsumerIdentifier, 
								varMessageID, aggregatedResponse);
		var overallResponseString = Packages.gov.nih.nci.ihub.util.IntegrationHubUtil.xmlToString(overallResponse);
		updateMessageServiceResponseInDB(isFailureOverallResponse, overallResponseString, varMessageID, globalMap.get(&quot;request.message.status.processed&quot;));
		return overallResponseString;

	} catch (error) {	
		logger.error(&quot;EXCEPTION OCCURED IN MIRTH RESPONSE AGGREGATOR &quot;+error);
	}

}</code>
    <type>FUNCTION</type>
    <scope>2</scope>
  </com.webreach.mirth.model.CodeTemplate>
  <com.webreach.mirth.model.CodeTemplate>
    <id>b59d044f-283f-4037-bf7e-81499dfac111</id>
    <name>updateMessageServiceStatusInDB</name>
    <tooltip>Updates the caBIG Integration Hub&apos;s MESSAGE table with the status for a specific messageID</tooltip>
    <code>function updateMessageServiceStatusInDB(varMessageStatus, varMessageID){
	var dbConn = getIHubDatabaseConnection();
	var updateSQL = &quot;UPDATE MESSAGE SET MESSAGE_STATUS=&apos;&quot;+varMessageStatus+&quot;&apos; WHERE MESSAGE_ID=&apos;&quot;+varMessageID+&quot;&apos;&quot;;
	dbConn.executeUpdate(updateSQL);
	dbConn.close();
}


//primarily used during synchronous processing of message
/*function updateAllMessageServiceStatusesInDB(varMessageStatus, varOverallResponseStatus, varMessageID){
	var dbConn = getIHubDatabaseConnection();
	var updateSQL = &quot;UPDATE MESSAGE SET MESSAGE_STATUS=&apos;&quot;+varMessageStatus+&quot;&apos; OVERALL_RESPONSE_STATUS=&apos;&quot;+varOverallResponseStatus+&quot;&apos; TIME_COMPLETED=? WHERE MESSAGE_ID=&apos;&quot;+varMessageID+&quot;&apos;&quot;;
	dbConn.executeUpdate(updateSQL);
	dbConn.close();
}*/</code>
    <type>FUNCTION</type>
    <scope>2</scope>
  </com.webreach.mirth.model.CodeTemplate>
  <com.webreach.mirth.model.CodeTemplate>
    <id>a6e2cab3-3709-486f-a2b6-3192c9709c0b</id>
    <name>invokeDelegationService</name>
    <tooltip>Invokes the caGrid Credential Delegation Service and returns a security Subject</tooltip>
    <code>function invokeDelegationService(varDelegatedCredentialReference, varCertFilePath, varKeyFilePath, varTargetDetailCode, varMessageID){
	try{		
		var delegateServiceBean = new Packages.gov.nih.nci.ihub.writer.ncies.infrastructure.InvokeDelegationServiceBean($(&apos;ns1metadata_ns1credentials_ns1grididentifier&apos;), 
						varDelegatedCredentialReference, varCertFilePath, varKeyFilePath, globalMap.get(&quot;user.proxy.cache.time.to.live&quot;));
		var subject = delegateServiceBean.invokeDelegationService();		
		logger.info(&quot;Subject in function invokeDelegationService(): &quot;+subject);	
		return subject;
	} catch (error) {	
		logger.error(&quot;EXCEPTION OCCURED IN MIRTH DURING &quot;+varTargetDetailsCode+&quot; INVOCATION: &quot;+error);
		insertCompiledTargetResponse(createErrorResponseXML(new Packages.java.lang.Exception(error), varTargetDetailsCode), 
			varTargetDetailsCode, globalMap.get(&quot;target.response.status.fault&quot;), varMessageID);
		throw error;
	}
}</code>
    <type>FUNCTION</type>
    <scope>2</scope>
  </com.webreach.mirth.model.CodeTemplate>
</list>